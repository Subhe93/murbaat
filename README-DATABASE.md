# دليل قاعدة البيانات - مربعات

## نظرة عامة

تم تصميم قاعدة البيانات لدعم نظام دليل الشركات الشامل مع إمكانيات البحث والتقييم والإدارة المتقدمة.

## الكيانات الرئيسية

### 1. البلدان (Countries)
- تخزين معلومات البلدان المدعومة
- العلاقات: مدن، شركات

### 2. المدن (Cities)
- تخزين معلومات المدن لكل بلد
- العلاقات: بلد واحد، شركات متعددة

### 3. الفئات (Categories)
- تصنيف الشركات حسب نوع النشاط
- العلاقات: شركات متعددة

### 4. الشركات (Companies)
- الكيان المحوري للنظام
- العلاقات: بلد، مدينة، فئة، صور، علامات، ساعات عمل، مراجعات، جوائز

### 5. المراجعات (Reviews)
- تقييمات العملاء للشركات
- العلاقات: شركة، صور، تقييمات مفيدة

### 6. المستخدمين (Users)
- نظام إدارة المستخدمين والأذونات
- الأدوار: مستخدم، مالك شركة، مدير، مدير عام

## الميزات المتقدمة

### البحث الذكي
- البحث النصي في أسماء الشركات والأوصاف
- فلترة حسب الموقع والفئة والتقييم
- البحث الجغرافي بالمسافة

### نظام التقييمات
- تقييم بالنجوم (1-5)
- مراجعات نصية مع صور
- تقييم المراجعات (مفيد/غير مفيد)
- نظام الموافقة والإشراف

### إدارة الصلاحيات
- أدوار متعددة للمستخدمين
- صلاحيات مفصلة لكل دور
- إدارة ملكية الشركات

### الإحصائيات والتحليلات
- إحصائيات يومية
- تحليل الأداء
- مقارنة المنافسين

## إعداد قاعدة البيانات

### 1. متطلبات النظام
```bash
# PostgreSQL 12+
# Node.js 18+
# npm أو yarn
```

### 2. التثبيت
```bash
# تثبيت التبعيات
npm install

# إعداد قاعدة البيانات
npm run db:setup
```

### 3. إعداد متغيرات البيئة
```env
DATABASE_URL="postgresql://username:password@localhost:5432/morabbat_db"
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"
```

### 4. تطبيق المخطط
```bash
# إنشاء قاعدة البيانات وتطبيق المخطط
npm run db:push

# ملء البيانات التجريبية
npm run db:seed

# فتح Prisma Studio للإدارة
npm run db:studio
```

## الاستعلامات الأساسية

### البحث عن الشركات
```typescript
import { getCompanies } from '@/lib/database/queries'

const companies = await getCompanies({
  query: 'تقنية',
  country: 'sy',
  city: 'damascus',
  category: 'technology',
  rating: 4,
  page: 1,
  limit: 12
})
```

### إضافة مراجعة
```typescript
import { createReview } from '@/lib/database/queries'

const review = await createReview({
  data: {
    companyId: 'company-id',
    userName: 'أحمد محمد',
    rating: 5,
    title: 'خدمة ممتازة',
    comment: 'تجربة رائعة مع الشركة'
  }
})
```

### إحصائيات المدير
```typescript
import { getAdminDashboardStats } from '@/lib/database/admin-queries'

const stats = await getAdminDashboardStats()
```

## الأمان والأذونات

### نظام الأدوار
- **USER**: مستخدم عادي (عرض، إضافة مراجعات)
- **COMPANY_OWNER**: مالك شركة (إدارة شركته)
- **ADMIN**: مدير (إدارة المحتوى)
- **SUPER_ADMIN**: مدير عام (إدارة كاملة)

### الصلاحيات
```typescript
import { hasPermission } from '@/lib/auth/permissions'

const canEdit = hasPermission(userRole, 'edit_company', ownerRole)
```

## الداشبوردات

### لوحة تحكم المدير (`/admin`)
- إحصائيات عامة
- إدارة الشركات والمراجعات
- إدارة المستخدمين
- تقارير وتحليلات

### لوحة تحكم الشركة (`/company-dashboard`)
- إحصائيات الشركة
- إدارة المراجعات
- تحديث المعلومات
- تحليل المنافسين

## الفصل والحماية

### فصل الصلاحيات
- مسارات منفصلة للمدير والشركات
- صلاحيات محددة لكل دور
- حماية البيانات الحساسة

### الحماية الأمنية
- تشفير كلمات المرور
- تتبع IP للمراجعات
- نظام الجلسات الآمنة
- معدل محدود للطلبات

## النسخ الاحتياطي والصيانة

### النسخ الاحتياطي
```bash
# إنشاء نسخة احتياطية
npm run db:backup

# استعادة من نسخة احتياطية
npm run db:restore backup-file.sql
```

### الصيانة
```bash
# تحديث الإحصائيات
npm run db:update-stats

# تنظيف البيانات القديمة
npm run db:cleanup

# إعادة فهرسة البحث
npm run db:reindex
```

## ملاحظات مهمة

1. **الأداء**: تم إضافة فهارس للبحث السريع
2. **التوسع**: المخطط قابل للتوسع لإضافة ميزات جديدة
3. **الأمان**: جميع البيانات الحساسة محمية
4. **المرونة**: دعم متعدد اللغات والعملات
5. **الموثوقية**: نظام النسخ الاحتياطي التلقائي

## الدعم الفني

للمساعدة في إعداد قاعدة البيانات أو حل المشاكل:
- مراجعة ملف `prisma/schema.prisma`
- استخدام `npm run db:studio` لإدارة البيانات
- مراجعة ملفات الاستعلامات في `lib/database/`
